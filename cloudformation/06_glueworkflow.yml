AWSTemplateFormatVersion: '2010-09-09'
Description: AWS Glue Workflow chaining Ingest → Transform → Quality → Metrics

Parameters:
  Prefix:
    Type: String
    Default: gp
  Environment:
    Type: String
    Default: dev

Resources:

  GlueWorkflow:
    Type: AWS::Glue::Workflow
    Properties:
      Name: !Sub "${Prefix}-glue-workflow-${Environment}"
      Description: Glue workflow for full ELT pipeline

  IngestTrigger:
    Type: AWS::Glue::Trigger
    Properties:
      Name: !Sub "${Prefix}-ingest-trigger-${Environment}"
      Type: SCHEDULED
      WorkflowName: !Ref GlueWorkflow
      Schedule: "cron(0 2 * * ? *)"
      StartOnCreation: true
      Actions:
        - JobName:
            !ImportValue
              Fn::Sub: "gp-glue-dev-IngestJobName"

  TransformTrigger:
    Type: AWS::Glue::Trigger
    Properties:
      Name: !Sub "${Prefix}-transform-trigger-${Environment}"
      Type: CONDITIONAL
      WorkflowName: !Ref GlueWorkflow
      StartOnCreation: true
      Predicate:
        Conditions:
          - JobName:
              !ImportValue
                Fn::Sub: "gp-glue-dev-IngestJobName"
            LogicalOperator: EQUALS
            State: SUCCEEDED
      Actions:
        - JobName:
            !ImportValue
              Fn::Sub: "gp-glue-dev-TransformJobName"

  QualityTrigger:
    Type: AWS::Glue::Trigger
    Properties:
      Name: !Sub "${Prefix}-quality-trigger-${Environment}"
      Type: CONDITIONAL
      WorkflowName: !Ref GlueWorkflow
      StartOnCreation: true
      Predicate:
        Conditions:
          - JobName:
              !ImportValue
                Fn::Sub: "gp-glue-dev-TransformJobName"
            LogicalOperator: EQUALS
            State: SUCCEEDED
      Actions:
        - JobName:
            !ImportValue
              Fn::Sub: "gp-glue-dev-QualityJobName"

  MetricsTrigger:
    Type: AWS::Glue::Trigger
    Properties:
      Name: !Sub "${Prefix}-metrics-trigger-${Environment}"
      Type: CONDITIONAL
      WorkflowName: !Ref GlueWorkflow
      StartOnCreation: true
      Predicate:
        Conditions:
          - JobName:
              !ImportValue
                Fn::Sub: "gp-glue-dev-QualityJobName"
            LogicalOperator: EQUALS
            State: SUCCEEDED
      Actions:
        - JobName:
            !ImportValue
              Fn::Sub: "gp-glue-dev-MetricsJobName"

Outputs:
  GlueWorkflowName:
    Description: Name of the Glue Workflow
    Value: !Ref GlueWorkflow
    Export:
      Name: !Sub "${AWS::StackName}-GlueWorkflow"
